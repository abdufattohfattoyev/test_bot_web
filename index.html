<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Tizimi</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .user-info {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: white;
            color: #4facfe;
            border-bottom: 3px solid #4facfe;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4facfe;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #fa4b99 0%, #ff6b6b 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .question-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #4facfe;
        }

        .answer-input {
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
            width: 100%;
        }

        .result-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .score {
            font-size: 1.2rem;
            font-weight: bold;
            color: #28a745;
        }

        .export-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }

        .hidden {
            display: none;
        }

        .success-msg {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }

        .error-msg {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Test Tizimi</h1>
            <p id="role-info">Test yaratish va topshirish</p>
            <div class="user-info" id="user-info"></div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('admin')">Admin Panel</button>
            <button class="tab-btn" onclick="showTab('student')">Test Topshirish</button>
            <button class="tab-btn" onclick="showTab('results')">Natijalar</button>
        </div>

        <!-- Admin Panel -->
        <div id="admin-tab" class="tab-content active">
            <h2>üîß Admin Panel</h2>
            
            <div class="form-group">
                <label>Test kodi:</label>
                <input type="text" id="admin-test-code" placeholder="Masalan: TEST001">
            </div>
            
            <div class="form-group">
                <label>Test nomi:</label>
                <input type="text" id="admin-test-title" placeholder="Test nomini kiriting">
            </div>
            
            <div class="form-group">
                <label>Ochiq savollar soni:</label>
                <input type="number" id="open-questions-count" min="0" value="0">
            </div>
            
            <div class="form-group">
                <label>Yopiq savollar soni:</label>
                <input type="number" id="closed-questions-count" min="0" value="0">
            </div>
            
            <div class="form-group">
                <label>Har bir yopiq savolda variantlar soni:</label>
                <input type="number" id="options-count" min="2" max="6" value="4">
            </div>
            
            <button class="btn btn-primary" onclick="createTest()">Test yaratish</button>
            <button class="btn btn-danger" onclick="debugStorage()">Debug Storage</button>
            
            <div id="answers-section" class="hidden">
                <h3>Javoblarni kiriting:</h3>
                <div id="answers-form"></div>
                <button class="btn btn-success" onclick="saveAnswers()">Javoblarni saqlash</button>
            </div>
        </div>

        <!-- Student Panel -->
        <div id="student-tab" class="tab-content">
            <h2>üìù Test Topshirish</h2>
            
            <div class="form-group">
                <label>Test kodi:</label>
                <input type="text" id="student-test-code" placeholder="Test kodini kiriting">
            </div>
            
            <div class="form-group">
                <label>Ism Familiya:</label>
                <input type="text" id="student-name" placeholder="Ism familiyangizni kiriting">
            </div>
            
            <button class="btn btn-primary" onclick="startTest()">Testni boshlash</button>
            
            <div id="test-section" class="hidden">
                <h3>Test savollari:</h3>
                <div id="test-form"></div>
                <button class="btn btn-success" onclick="submitTest()">Testni yakunlash</button>
            </div>
        </div>

        <!-- Results Panel -->
        <div id="results-tab" class="tab-content">
            <h2>üìä Natijalar</h2>
            
            <div class="form-group">
                <label>Test kodi:</label>
                <input type="text" id="results-test-code" placeholder="Test kodini kiriting">
                <button class="btn btn-primary" onclick="loadResults()">Natijalarni yuklash</button>
            </div>
            
            <div id="results-section"></div>
        </div>
    </div>

    <script>
        // Global variables
        let telegramId = null;
        let userRole = 'student';  // Default student
        let currentTest = null;
        let isAdmin = false;
        let userData = {};

        // Admin IDs - sizning ID ingiz
        const ADMIN_IDS = [973358587];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // Telegram Web App initialization
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            
            // Telegram dan user ma'lumotlarini olish
            if (window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                const user = window.Telegram.WebApp.initDataUnsafe.user;
                telegramId = user.id;
                userData = {
                    id: user.id,
                    first_name: user.first_name || '',
                    last_name: user.last_name || '',
                    username: user.username || '',
                    language_code: user.language_code || 'uz'
                };
            }
        }

        // URL dan parametrlarni olish
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('telegram_id')) {
            telegramId = parseInt(urlParams.get('telegram_id'));
            // Agar URL dan kelsa, userData yaratish
            if (!userData.id) {
                userData = {
                    id: telegramId,
                    first_name: 'Unknown',
                    last_name: '',
                    username: '',
                    language_code: 'uz'
                };
            }
        }
        userRole = urlParams.get('role') || 'student';

        function initializeApp() {
            // Admin ekanligini tekshirish
            isAdmin = ADMIN_IDS.includes(telegramId);
            
            // Foydalanuvchini bazaga qo'shish
            saveUserToDatabase();
            
            // User info ko'rsatish
            const fullName = `${userData.first_name} ${userData.last_name}`.trim() || 'Unknown User';
            document.getElementById('user-info').innerHTML = `üë§ ${fullName} | üÜî ID: ${telegramId} | üëë Admin: ${isAdmin ? 'Ha' : 'Yo\'q'}`;
            
            // Tab larni ko'rsatish/yashirish
            setupInterface();
        }

        function saveUserToDatabase() {
            if (!telegramId) return;

            // LocalStorage dan mavjud users ma'lumotini olish
            let users = JSON.parse(localStorage.getItem('users') || '{}');
            
            // Foydalanuvchi ma'lumotlarini yangilash yoki qo'shish
            users[telegramId] = {
                ...userData,
                last_seen: new Date().toISOString(),
                is_admin: isAdmin,
                total_tests: users[telegramId]?.total_tests || 0,
                first_visit: users[telegramId]?.first_visit || new Date().toISOString()
            };

            // LocalStorage ga saqlash
            localStorage.setItem('users', JSON.stringify(users));
            
            console.log('User saved to database:', users[telegramId]);
        }

        function setupInterface() {
            const tabsContainer = document.querySelector('.tabs');
            
            if (isAdmin && userRole === 'admin') {
                // Admin uchun barcha tablar
                tabsContainer.innerHTML = `
                    <button class="tab-btn active" onclick="showTab('admin')">Admin Panel</button>
                    <button class="tab-btn" onclick="showTab('student')">Test Ko'rish</button>
                    <button class="tab-btn" onclick="showTab('results')">Natijalar</button>
                `;
                document.getElementById('admin-tab').classList.add('active');
                document.getElementById('student-tab').classList.remove('active');
                document.getElementById('results-tab').classList.remove('active');
            } else {
                // Student uchun faqat test topshirish
                tabsContainer.innerHTML = `
                    <button class="tab-btn active" onclick="showTab('student')">Test Topshirish</button>
                    <button class="tab-btn" onclick="showTab('stats')">Statistika</button>
                `;
                document.getElementById('admin-tab').classList.remove('active');
                document.getElementById('student-tab').classList.add('active');
                document.getElementById('results-tab').classList.remove('active');
                
                // Admin panelni yashirish
                document.getElementById('admin-tab').style.display = 'none';
                document.getElementById('results-tab').style.display = 'none';
                
                // Stats tabini yaratish
                if (!document.getElementById('stats-tab')) {
                    const statsTab = document.createElement('div');
                    statsTab.id = 'stats-tab';
                    statsTab.className = 'tab-content';
                    statsTab.innerHTML = `
                        <h2>üìä Mening Statistikam</h2>
                        <div id="user-stats"></div>
                    `;
                    document.querySelector('.container').appendChild(statsTab);
                }
                
                // User statistikasini ko'rsatish
                showUserStats();
            }
        }

        // LocalStorage dan ma'lumotlarni olish
        let testData = JSON.parse(localStorage.getItem('testData') || '{}');

        // Tab switching
        function showTab(tabName) {
            // Admin huquqlarini tekshirish
            if ((tabName === 'admin' || tabName === 'results') && !isAdmin) {
                showMessage('‚ùå Sizda admin huquqlari yo\'q!', 'error');
                return;
            }
            
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            // Agar stats tabini ochsa, yangi ma'lumot ko'rsatish
            if (tabName === 'stats') {
                showUserStats();
            }
        }

        function showUserStats() {
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const currentUser = users[telegramId];
            const testData = JSON.parse(localStorage.getItem('testData') || '{}');
            
            if (!currentUser) {
                document.getElementById('user-stats').innerHTML = '<p>Foydalanuvchi ma\'lumotlari topilmadi.</p>';
                return;
            }

            // Foydalanuvchi topshirgan testlarni hisoblash
            let completedTests = 0;
            let totalScore = 0;
            let totalQuestions = 0;
            
            Object.values(testData).forEach(test => {
                if (test.students) {
                    Object.values(test.students).forEach(student => {
                        if (student.telegramId === telegramId) {
                            completedTests++;
                            totalScore += student.score || 0;
                            totalQuestions += student.total || 0;
                        }
                    });
                }
            });

            const averagePercentage = totalQuestions > 0 ? Math.round((totalScore / totalQuestions) * 100) : 0;

            const statsHtml = `
                <div class="result-item">
                    <h3>üë§ Shaxsiy Ma'lumotlar</h3>
                    <p><strong>Ism:</strong> ${currentUser.first_name} ${currentUser.last_name}</p>
                    <p><strong>Username:</strong> ${currentUser.username ? '@' + currentUser.username : 'Yo\'q'}</p>
                    <p><strong>ID:</strong> ${currentUser.id}</p>
                    <p><strong>Birinchi tashrif:</strong> ${new Date(currentUser.first_visit).toLocaleString('uz-UZ')}</p>
                    <p><strong>Oxirgi tashrif:</strong> ${new Date(currentUser.last_seen).toLocaleString('uz-UZ')}</p>
                </div>
                
                <div class="result-item">
                    <h3>üìä Test Statistikasi</h3>
                    <p><strong>Topshirilgan testlar:</strong> ${completedTests}</p>
                    <p><strong>Jami to'g'ri javoblar:</strong> ${totalScore}</p>
                    <p><strong>Jami savollar:</strong> ${totalQuestions}</p>
                    <p><strong>O'rtacha natija:</strong> ${averagePercentage}%</p>
                    <div class="score">Umumiy reyting: ${averagePercentage >= 80 ? 'üèÜ A\'lo' : averagePercentage >= 60 ? 'ü•à Yaxshi' : averagePercentage >= 40 ? 'ü•â Qoniqarli' : 'üìö Yaxshilanishi kerak'}</div>
                </div>
            `;
            
            document.getElementById('user-stats').innerHTML = statsHtml;
        }

        // Admin: Create test
        function createTest() {
            if (!isAdmin) {
                showMessage('‚ùå Sizda admin huquqlari yo\'q!', 'error');
                return;
            }
            
            const testCode = document.getElementById('admin-test-code').value.trim();
            const testTitle = document.getElementById('admin-test-title').value.trim();
            const openCount = parseInt(document.getElementById('open-questions-count').value);
            const closedCount = parseInt(document.getElementById('closed-questions-count').value);
            const optionsCount = parseInt(document.getElementById('options-count').value);

            if (!testCode || !testTitle || (openCount === 0 && closedCount === 0)) {
                showMessage('Barcha maydonlarni to\'ldiring va kamida bitta savol turi kerak!', 'error');
                return;
            }

            // Test strukturasini yaratish
            testData[testCode] = {
                title: testTitle,
                openCount: openCount,
                closedCount: closedCount,
                optionsCount: optionsCount,
                answers: {},
                students: {},
                createdBy: telegramId,
                createdAt: new Date().toISOString()
            };

            localStorage.setItem('testData', JSON.stringify(testData));

            // Javoblar formasini yaratish
            createAnswersForm(testCode, openCount, closedCount, optionsCount);
            document.getElementById('answers-section').classList.remove('hidden');
            showMessage('Test yaratildi! Endi javoblarni kiriting.', 'success');
        }

        // Create answers form
        function createAnswersForm(testCode, openCount, closedCount, optionsCount) {
            const form = document.getElementById('answers-form');
            form.innerHTML = '';

            // Open questions
            for (let i = 1; i <= openCount; i++) {
                const div = document.createElement('div');
                div.className = 'question-item';
                div.innerHTML = `
                    <label>Ochiq savol ${i} - To'g'ri javob:</label>
                    <input type="text" id="open-${i}" class="answer-input" placeholder="To'g'ri javobni kiriting">
                `;
                form.appendChild(div);
            }

            // Closed questions
            for (let i = 1; i <= closedCount; i++) {
                const div = document.createElement('div');
                div.className = 'question-item';
                div.innerHTML = `
                    <label>Yopiq savol ${i} - To'g'ri javob:</label>
                    <select id="closed-${i}" class="answer-input">
                        ${Array.from({length: optionsCount}, (_, j) => 
                            `<option value="${String.fromCharCode(65 + j)}">${String.fromCharCode(65 + j)}</option>`
                        ).join('')}
                    </select>
                `;
                form.appendChild(div);
            }
        }

        // Save answers
        function saveAnswers() {
            if (!isAdmin) {
                showMessage('‚ùå Sizda admin huquqlari yo\'q!', 'error');
                return;
            }
            
            const testCode = document.getElementById('admin-test-code').value.trim();
            const testInfo = testData[testCode];
            
            if (!testInfo) {
                showMessage('Test topilmadi!', 'error');
                return;
            }

            const answers = {};
            let emptyCount = 0;

            // Open answers
            for (let i = 1; i <= testInfo.openCount; i++) {
                const element = document.getElementById(`open-${i}`);
                if (element) {
                    const answer = element.value.trim();
                    if (answer) {
                        answers[`open-${i}`] = answer.toLowerCase();
                    } else {
                        emptyCount++;
                    }
                }
            }

            // Closed answers
            for (let i = 1; i <= testInfo.closedCount; i++) {
                const element = document.getElementById(`closed-${i}`);
                if (element) {
                    const answer = element.value;
                    if (answer) {
                        answers[`closed-${i}`] = answer;
                    } else {
                        emptyCount++;
                    }
                }
            }

            if (emptyCount > 0) {
                showMessage(`${emptyCount} ta javob kiritilmagan!`, 'error');
                return;
            }

            // Save answers
            testData[testCode].answers = answers;
            localStorage.setItem('testData', JSON.stringify(testData));
            
            // Debug - console da ko'rsatish
            console.log('Saqlangan testData:', testData);
            console.log('Javoblar:', answers);
            
            showMessage(`Javoblar saqlandi! (${Object.keys(answers).length} ta javob)`, 'success');
        }

        // Student: Start test
        function startTest() {
            const testCode = document.getElementById('student-test-code').value.trim();
            const studentName = document.getElementById('student-name').value.trim();

            if (!testCode || !studentName) {
                showMessage('Test kodi va ism-familiya kerak!', 'error');
                return;
            }

            // LocalStorage dan ma'lumot olish
            testData = JSON.parse(localStorage.getItem('testData') || '{}');
            
            if (!testData[testCode]) {
                showMessage('Test topilmadi yoki admin javoblarni kiritmagan!', 'error');
                console.log('Mavjud testlar:', Object.keys(testData));
                return;
            }

            if (!testData[testCode].answers || Object.keys(testData[testCode].answers).length === 0) {
                showMessage('Test javoblari kiritilmagan! Admin bilan bog\'laning.', 'error');
                return;
            }

            currentTest = testData[testCode];
            createTestForm(testCode);
            document.getElementById('test-section').classList.remove('hidden');
            showMessage('Test boshlandi!', 'success');
        }

        // Create test form for student
        function createTestForm(testCode) {
            const test = testData[testCode];
            const form = document.getElementById('test-form');
            form.innerHTML = '';

            // Open questions
            for (let i = 1; i <= test.openCount; i++) {
                const div = document.createElement('div');
                div.className = 'question-item';
                div.innerHTML = `
                    <label>Ochiq savol ${i}:</label>
                    <input type="text" id="student-open-${i}" class="answer-input" placeholder="Javobingizni kiriting">
                `;
                form.appendChild(div);
            }

            // Closed questions
            for (let i = 1; i <= test.closedCount; i++) {
                const div = document.createElement('div');
                div.className = 'question-item';
                div.innerHTML = `
                    <label>Yopiq savol ${i}:</label>
                    <select id="student-closed-${i}" class="answer-input">
                        <option value="">Javobni tanlang</option>
                        ${Array.from({length: test.optionsCount}, (_, j) => 
                            `<option value="${String.fromCharCode(65 + j)}">${String.fromCharCode(65 + j)}</option>`
                        ).join('')}
                    </select>
                `;
                form.appendChild(div);
            }
        }

        // Submit test
        function submitTest() {
            const testCode = document.getElementById('student-test-code').value.trim();
            const studentName = document.getElementById('student-name').value.trim();

            if (!currentTest) {
                showMessage('Test ma\'lumotlari topilmadi!', 'error');
                return;
            }

            const answers = {};
            let score = 0;
            let totalQuestions = currentTest.openCount + currentTest.closedCount;

            // Collect and check open answers
            for (let i = 1; i <= currentTest.openCount; i++) {
                const studentAnswer = document.getElementById(`student-open-${i}`).value.trim().toLowerCase();
                const correctAnswer = currentTest.answers[`open-${i}`];
                
                answers[`open-${i}`] = studentAnswer;
                
                if (correctAnswer && studentAnswer === correctAnswer) {
                    score++;
                }
            }

            // Collect and check closed answers
            for (let i = 1; i <= currentTest.closedCount; i++) {
                const studentAnswer = document.getElementById(`student-closed-${i}`).value;
                const correctAnswer = currentTest.answers[`closed-${i}`];
                
                answers[`closed-${i}`] = studentAnswer;
                
                if (studentAnswer === correctAnswer) {
                    score++;
                }
            }

            // Save student result
            if (!testData[testCode].students) {
                testData[testCode].students = {};
            }

            testData[testCode].students[studentName] = {
                answers: answers,
                score: score,
                total: totalQuestions,
                percentage: Math.round((score / totalQuestions) * 100),
                telegramId: telegramId,
                timestamp: new Date().toLocaleString('uz-UZ')
            };

            localStorage.setItem('testData', JSON.stringify(testData));

            // Foydalanuvchi test sonini yangilash
            updateUserTestCount();

            showMessage(`Test yakunlandi!\nNatija: ${score}/${totalQuestions} (${Math.round((score / totalQuestions) * 100)}%)`, 'success');
        }

        function updateUserTestCount() {
            let users = JSON.parse(localStorage.getItem('users') || '{}');
            if (users[telegramId]) {
                users[telegramId].total_tests = (users[telegramId].total_tests || 0) + 1;
                users[telegramId].last_seen = new Date().toISOString();
                localStorage.setItem('users', JSON.stringify(users));
            }
        }

        // Load results
        function loadResults() {
            if (!isAdmin) {
                showMessage('‚ùå Sizda admin huquqlari yo\'q!', 'error');
                return;
            }
            
            const testCode = document.getElementById('results-test-code').value.trim();
            
            if (!testCode) {
                showMessage('Test kodi kerak!', 'error');
                return;
            }

            // LocalStorage dan yangi ma'lumot olish
            testData = JSON.parse(localStorage.getItem('testData') || '{}');
            
            if (!testData[testCode]) {
                showMessage('Test topilmadi!', 'error');
                return;
            }

            const testInfo = testData[testCode];
            const students = testInfo.students || {};
            const resultsSection = document.getElementById('results-section');

            if (Object.keys(students).length === 0) {
                resultsSection.innerHTML = '<p>Hali hech kim test topshirmagan.</p>';
                return;
            }

            let html = `<h3>${testInfo.title} - Test natijalari:</h3>`;
            
            Object.entries(students).forEach(([name, data]) => {
                html += `
                    <div class="result-item">
                        <h4>${name}</h4>
                        <div class="score">Natija: ${data.score}/${data.total} (${data.percentage}%)</div>
                        <p>ID: ${data.telegramId}</p>
                        <p>Vaqt: ${data.timestamp}</p>
                    </div>
                `;
            });

            html += `<button class="export-btn" onclick="exportResults('${testCode}')">Excel ga export qilish</button>`;
            
            resultsSection.innerHTML = html;
        }

        // Export results
        function exportResults(testCode) {
            const testInfo = testData[testCode];
            const students = testInfo.students || {};

            let csv = 'Ism Familiya,Telegram ID,To\'g\'ri javoblar,Umumiy savollar,Foiz,Vaqt\n';
            
            Object.entries(students).forEach(([name, data]) => {
                csv += `"${name}",${data.telegramId},${data.score},${data.total},${data.percentage}%,"${data.timestamp}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `test_${testCode}_results.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('Natijalar yuklab olindi!', 'success');
        }

        // Show message
        function showMessage(message, type) {
            const className = type === 'success' ? 'success-msg' : 'error-msg';
            const messageDiv = document.createElement('div');
            messageDiv.className = className;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (document.body.contains(messageDiv)) {
                    document.body.removeChild(messageDiv);
                }
            }, 5000);
        }

        // Debug function
        function debugStorage() {
            const storage = localStorage.getItem('testData');
            const users = localStorage.getItem('users');
            
            console.log('LocalStorage testData:', storage);
            console.log('LocalStorage users:', users);
            
            let debugInfo = 'LocalStorage ma\'lumotlari:\n\n';
            
            // Test ma'lumotlari
            if (storage) {
                const parsed = JSON.parse(storage);
                debugInfo += '=== TESTLAR ===\n';
                Object.keys(parsed).forEach(testCode => {
                    const test = parsed[testCode];
                    debugInfo += `Test: ${testCode}\n`;
                    debugInfo += `- Title: ${test.title}\n`;
                    debugInfo += `- Savollar: ${test.openCount + test.closedCount}\n`;
                    debugInfo += `- Javoblar: ${Object.keys(test.answers || {}).length}\n`;
                    debugInfo += `- Ishtirokchilar: ${Object.keys(test.students || {}).length}\n\n`;
                });
            }
            
            // Users ma'lumotlari
            if (users) {
                const parsedUsers = JSON.parse(users);
                debugInfo += '\n=== FOYDALANUVCHILAR ===\n';
                Object.values(parsedUsers).forEach(user => {
                    debugInfo += `üë§ ${user.first_name} ${user.last_name}\n`;
                    debugInfo += `ID: ${user.id}\n`;
                    debugInfo += `Testlar: ${user.total_tests || 0}\n`;
                    debugInfo += `Admin: ${user.is_admin ? 'Ha' : 'Yo\'q'}\n\n`;
                });
            }
            
            if (!storage && !users) {
                debugInfo = 'LocalStorage bo\'sh!';
            }
            
            alert(debugInfo);
        }
    </script>
</body>
</html>
