<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Tizimi</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #3a7bd5 0%, #00d2ff 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .user-info {
            background: rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 50px;
            margin-top: 15px;
            font-size: 14px;
            display: inline-block;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s;
            position: relative;
        }

        .tab-btn.active {
            background: white;
            color: #3a7bd5;
        }

        .tab-btn.active:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 3px;
            background: #3a7bd5;
            border-radius: 3px 3px 0 0;
        }

        .tab-content {
            display: none;
            padding: 25px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .form-control:focus {
            outline: none;
            border-color: #3a7bd5;
            background: white;
            box-shadow: 0 0 0 3px rgba(58, 123, 213, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn i {
            margin-right: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3a7bd5 0%, #00d2ff 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #bdc3c7 0%, #2c3e50 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* Test savollari uchun stil */
        .question-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-left: 4px solid #3a7bd5;
        }

        .question-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .option-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid #e9ecef;
        }

        .option-item:hover {
            background: #e9ecef;
        }

        .option-item.selected {
            background: #d1e7ff;
            border-color: #3a7bd5;
        }

        .option-letter {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #3a7bd5;
            color: white;
            font-weight: bold;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .option-text {
            flex-grow: 1;
        }

        /* Natijalar uchun stil */
        .result-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-left: 4px solid #38ef7d;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .result-name {
            font-weight: 600;
            font-size: 18px;
            color: #333;
        }

        .score {
            font-size: 1.2rem;
            font-weight: bold;
            color: #11998e;
        }

        .progress-container {
            width: 100%;
            height: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #38ef7d, #11998e);
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .result-details {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }

        /* Xabarlar uchun stil */
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 15px;
            display: flex;
            align-items: center;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert i {
            margin-right: 10px;
            font-size: 18px;
        }

        /* Yashirin elementlar */
        .hidden {
            display: none;
        }

        /* Test natijalari */
        .test-summary {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .test-title {
            font-size: 24px;
            margin-bottom: 10px;
            color: #3a7bd5;
        }

        .test-score {
            font-size: 32px;
            font-weight: bold;
            color: #11998e;
            margin: 10px 0;
        }

        .test-percentage {
            font-size: 18px;
            color: #666;
        }

        /* Ikonlar uchun joy */
        .icon {
            margin-right: 8px;
        }

        /* Responsive stil */
        @media (max-width: 768px) {
            .container {
                border-radius: 0;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab-btn {
                padding: 12px;
            }
            
            .options-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <!-- Font Awesome ikonlari -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-graduation-cap"></i> Test Tizimi</h1>
            <p id="role-info">Professional test yaratish va topshirish platformasi</p>
            <div class="user-info" id="user-info">
                <i class="fas fa-user"></i> ID: ... | <i class="fas fa-user-tag"></i> Yuklanmoqda...
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('admin')"><i class="fas fa-cogs"></i> Admin</button>
            <button class="tab-btn" onclick="showTab('student')"><i class="fas fa-edit"></i> Test</button>
            <button class="tab-btn" onclick="showTab('results')"><i class="fas fa-chart-bar"></i> Natijalar</button>
        </div>

        <!-- Admin Panel -->
        <div id="admin-tab" class="tab-content active">
            <h2><i class="fas fa-cogs"></i> Admin Panel</h2>
            
            <div class="alert alert-info" id="admin-alert" style="display: none;"></div>
            
            <div class="form-group">
                <label><i class="fas fa-barcode"></i> Test kodi:</label>
                <input type="text" id="admin-test-code" class="form-control" placeholder="TEST001">
            </div>
            
            <div class="form-group">
                <label><i class="fas fa-heading"></i> Test nomi:</label>
                <input type="text" id="admin-test-title" class="form-control" placeholder="Test nomini kiriting">
            </div>
            
            <div class="form-group">
                <label><i class="fas fa-question-circle"></i> Ochiq savollar soni:</label>
                <input type="number" id="open-questions-count" class="form-control" min="0" value="0">
            </div>
            
            <div class="form-group">
                <label><i class="fas fa-list-ol"></i> Yopiq savollar soni:</label>
                <input type="number" id="closed-questions-count" class="form-control" min="0" value="5">
            </div>
            
            <div class="form-group">
                <label><i class="fas fa-tasks"></i> Har bir yopiq savolda variantlar soni:</label>
                <input type="number" id="options-count" class="form-control" min="2" max="6" value="4">
            </div>
            
            <div class="form-group">
                <button class="btn btn-primary" onclick="createTest()"><i class="fas fa-plus-circle"></i> Test yaratish</button>
                <button class="btn btn-secondary" onclick="debugStorage()"><i class="fas fa-bug"></i> Debug</button>
            </div>
            
            <div id="answers-section" class="hidden">
                <h3><i class="fas fa-check-circle"></i> Javoblarni kiriting:</h3>
                <div id="answers-form"></div>
                <button class="btn btn-success" onclick="saveAnswers()"><i class="fas fa-save"></i> Javoblarni saqlash</button>
            </div>
        </div>

        <!-- Student Panel -->
        <div id="student-tab" class="tab-content">
            <h2><i class="fas fa-edit"></i> Test Topshirish</h2>
            
            <div class="alert" id="student-alert" style="display: none;"></div>
            
            <div class="form-group">
                <label><i class="fas fa-barcode"></i> Test kodi:</label>
                <input type="text" id="student-test-code" class="form-control" placeholder="Test kodini kiriting">
            </div>
            
            <div class="form-group">
                <label><i class="fas fa-user"></i> Ism Familiya:</label>
                <input type="text" id="student-name" class="form-control" placeholder="Ism familiyangizni kiriting">
            </div>
            
            <button class="btn btn-primary" onclick="startTest()"><i class="fas fa-play"></i> Testni boshlash</button>
            
            <div id="test-section" class="hidden">
                <div class="test-summary">
                    <h3 class="test-title" id="test-display-title">Test nomi</h3>
                    <p id="test-instructions">Har bir savolga javob bering. Testni tugatgach, "Testni yakunlash" tugmasini bosing.</p>
                </div>
                
                <div id="test-form"></div>
                
                <div class="form-group" style="text-align: center;">
                    <button class="btn btn-success" onclick="submitTest()"><i class="fas fa-check-circle"></i> Testni yakunlash</button>
                    <button class="btn btn-danger" onclick="cancelTest()"><i class="fas fa-times-circle"></i> Bekor qilish</button>
                </div>
            </div>
            
            <div id="test-result-section" class="hidden">
                <div class="test-summary">
                    <h3 class="test-title">Test natijalari</h3>
                    <div class="test-score" id="result-score">0/0</div>
                    <div class="test-percentage" id="result-percentage">0%</div>
                    <div class="progress-container">
                        <div class="progress-bar" id="result-progress" style="width: 0%"></div>
                    </div>
                    <p id="result-message"></p>
                </div>
                
                <button class="btn btn-primary" onclick="restartTest()"><i class="fas fa-redo"></i> Yangi test</button>
            </div>
        </div>

        <!-- Results Panel -->
        <div id="results-tab" class="tab-content">
            <h2><i class="fas fa-chart-bar"></i> Natijalar</h2>
            
            <div class="alert" id="results-alert" style="display: none;"></div>
            
            <div class="form-group">
                <label><i class="fas fa-barcode"></i> Test kodi:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="results-test-code" class="form-control" placeholder="Test kodini kiriting">
                    <button class="btn btn-primary" onclick="loadResults()"><i class="fas fa-search"></i> Yuklash</button>
                </div>
            </div>
            
            <div id="results-section"></div>
        </div>
    </div>

    <script>
        // Global variables
        let telegramId = null;
        let userRole = 'student';
        let currentTest = null;
        let isAdmin = false;
        let testInProgress = false;

        // Admin IDs - sizning ID ingiz
        const ADMIN_IDS = [973358587];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // Telegram Web App initialization
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            
            if (window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                telegramId = window.Telegram.WebApp.initDataUnsafe.user.id;
            }
        }

        // URL dan parametrlarni olish
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('telegram_id')) {
            telegramId = parseInt(urlParams.get('telegram_id'));
        }
        userRole = urlParams.get('role') || 'student';

        function initializeApp() {
            // Admin ekanligini tekshirish
            isAdmin = ADMIN_IDS.includes(telegramId);
            
            // User info ko'rsatish
            updateUserInfo();
            
            // Tab larni ko'rsatish/yashirish
            setupInterface();
            
            // LocalStorage dan ma'lumotlarni olish
            testData = JSON.parse(localStorage.getItem('testData') || '{}');
        }

        function updateUserInfo() {
            const userInfo = document.getElementById('user-info');
            if (userInfo) {
                userInfo.innerHTML = `
                    <i class="fas fa-user"></i> ID: ${telegramId || 'Noma\'lum'} | 
                    <i class="fas fa-user-tag"></i> ${userRole === 'admin' ? 'Admin' : 'Talaba'} | 
                    <i class="fas fa-crown"></i> ${isAdmin ? 'Ha' : 'Yo\'q'}
                `;
            }
        }

        function setupInterface() {
            const tabsContainer = document.querySelector('.tabs');
            
            if (isAdmin && userRole === 'admin') {
                // Admin uchun barcha tablar
                tabsContainer.innerHTML = `
                    <button class="tab-btn active" onclick="showTab('admin')"><i class="fas fa-cogs"></i> Admin</button>
                    <button class="tab-btn" onclick="showTab('student')"><i class="fas fa-edit"></i> Test</button>
                    <button class="tab-btn" onclick="showTab('results')"><i class="fas fa-chart-bar"></i> Natijalar</button>
                `;
                document.getElementById('admin-tab').classList.add('active');
                document.getElementById('student-tab').classList.remove('active');
                document.getElementById('results-tab').classList.remove('active');
            } else {
                // Student uchun faqat test topshirish
                tabsContainer.innerHTML = `
                    <button class="tab-btn active" onclick="showTab('student')"><i class="fas fa-edit"></i> Test Topshirish</button>
                `;
                document.getElementById('admin-tab').classList.remove('active');
                document.getElementById('student-tab').classList.add('active');
                document.getElementById('results-tab').classList.remove('active');
                
                // Admin panelni yashirish
                document.getElementById('admin-tab').style.display = 'none';
                document.getElementById('results-tab').style.display = 'none';
            }
        }

        // LocalStorage dan ma'lumotlarni olish
        let testData = JSON.parse(localStorage.getItem('testData') || '{}');

        // Tab switching
        function showTab(tabName) {
            // Admin huquqlarini tekshirish
            if ((tabName === 'admin' || tabName === 'results') && !isAdmin) {
                showAlert('❌ Sizda admin huquqlari yo\'q!', 'error', 'student-alert');
                return;
            }
            
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // Admin: Create test
        function createTest() {
            if (!isAdmin) {
                showAlert('❌ Sizda admin huquqlari yo\'q!', 'error', 'admin-alert');
                return;
            }
            
            const testCode = document.getElementById('admin-test-code').value.trim().toUpperCase();
            const testTitle = document.getElementById('admin-test-title').value.trim();
            const openCount = parseInt(document.getElementById('open-questions-count').value);
            const closedCount = parseInt(document.getElementById('closed-questions-count').value);
            const optionsCount = parseInt(document.getElementById('options-count').value);

            if (!testCode || !testTitle || (openCount === 0 && closedCount === 0)) {
                showAlert('Barcha maydonlarni to\'ldiring va kamida bitta savol turi kerak!', 'error', 'admin-alert');
                return;
            }

            // Test strukturasini yaratish
            testData[testCode] = {
                title: testTitle,
                openCount: openCount,
                closedCount: closedCount,
                optionsCount: optionsCount,
                answers: {},
                students: {},
                createdBy: telegramId,
                createdAt: new Date().toLocaleString('uz-UZ')
            };

            localStorage.setItem('testData', JSON.stringify(testData));

            // Javoblar formasini yaratish
            createAnswersForm(testCode, openCount, closedCount, optionsCount);
            document.getElementById('answers-section').classList.remove('hidden');
            showAlert('✅ Test yaratildi! Endi javoblarni kiriting.', 'success', 'admin-alert');
        }

        // Create answers form
        function createAnswersForm(testCode, openCount, closedCount, optionsCount) {
            const form = document.getElementById('answers-form');
            form.innerHTML = '';

            // Open questions
            for (let i = 1; i <= openCount; i++) {
                const div = document.createElement('div');
                div.className = 'question-item';
                div.innerHTML = `
                    <div class="question-title">Ochiq savol ${i} - To'g'ri javob:</div>
                    <input type="text" id="open-${i}" class="form-control" placeholder="To'g'ri javobni kiriting">
                `;
                form.appendChild(div);
            }

            // Closed questions
            for (let i = 1; i <= closedCount; i++) {
                const div = document.createElement('div');
                div.className = 'question-item';
                div.innerHTML = `
                    <div class="question-title">Yopiq savol ${i} - To'g'ri javob:</div>
                    <select id="closed-${i}" class="form-control">
                        <option value="">Tanlang</option>
                        ${Array.from({length: optionsCount}, (_, j) => 
                            `<option value="${String.fromCharCode(65 + j)}">${String.fromCharCode(65 + j)} variant</option>`
                        ).join('')}
                    </select>
                `;
                form.appendChild(div);
            }
        }

        // Save answers
        function saveAnswers() {
            if (!isAdmin) {
                showAlert('❌ Sizda admin huquqlari yo\'q!', 'error', 'admin-alert');
                return;
            }
            
            const testCode = document.getElementById('admin-test-code').value.trim().toUpperCase();
            const testInfo = testData[testCode];
            
            if (!testInfo) {
                showAlert('Test topilmadi!', 'error', 'admin-alert');
                return;
            }

            const answers = {};
            let emptyCount = 0;

            // Open answers
            for (let i = 1; i <= testInfo.openCount; i++) {
                const element = document.getElementById(`open-${i}`);
                if (element) {
                    const answer = element.value.trim();
                    if (answer) {
                        answers[`open-${i}`] = answer.toLowerCase();
                    } else {
                        emptyCount++;
                    }
                }
            }

            // Closed answers
            for (let i = 1; i <= testInfo.closedCount; i++) {
                const element = document.getElementById(`closed-${i}`);
                if (element) {
                    const answer = element.value;
                    if (answer) {
                        answers[`closed-${i}`] = answer;
                    } else {
                        emptyCount++;
                    }
                }
            }

            if (emptyCount > 0) {
                showAlert(`${emptyCount} ta javob kiritilmagan!`, 'error', 'admin-alert');
                return;
            }

            // Save answers
            testData[testCode].answers = answers;
            localStorage.setItem('testData', JSON.stringify(testData));
            
            showAlert(`✅ Javoblar saqlandi! (${Object.keys(answers).length} ta javob)`, 'success', 'admin-alert');
        }

        // Student: Start test
        function startTest() {
            const testCode = document.getElementById('student-test-code').value.trim().toUpperCase();
            const studentName = document.getElementById('student-name').value.trim();

            if (!testCode || !studentName) {
                showAlert('Test kodi va ism-familiya kerak!', 'error', 'student-alert');
                return;
            }

            // LocalStorage dan ma'lumot olish
            testData = JSON.parse(localStorage.getItem('testData') || '{}');
            
            if (!testData[testCode]) {
                showAlert('Test topilmadi! Admin bilan bog\'laning.', 'error', 'student-alert');
                return;
            }

            if (!testData[testCode].answers || Object.keys(testData[testCode].answers).length === 0) {
                showAlert('Test javoblari kiritilmagan! Admin bilan bog\'laning.', 'error', 'student-alert');
                return;
            }

            currentTest = testData[testCode];
            testInProgress = true;
            
            // Test nomini ko'rsatish
            document.getElementById('test-display-title').textContent = currentTest.title;
            
            createTestForm(testCode);
            document.getElementById('test-section').classList.remove('hidden');
            document.getElementById('student-alert').style.display = 'none';
            showAlert('Test boshlandi! Savollarga javob bering.', 'success', 'student-alert');
        }

        // Create test form for student
        function createTestForm(testCode) {
            const test = testData[testCode];
            const form = document.getElementById('test-form');
            form.innerHTML = '';

            // Open questions
            for (let i = 1; i <= test.openCount; i++) {
                const div = document.createElement('div');
                div.className = 'question-item';
                div.innerHTML = `
                    <div class="question-title">Ochiq savol ${i}:</div>
                    <input type="text" id="student-open-${i}" class="form-control" placeholder="Javobingizni kiriting">
                `;
                form.appendChild(div);
            }

            // Closed questions
            for (let i = 1; i <= test.closedCount; i++) {
                const div = document.createElement('div');
                div.className = 'question-item';
                
                let optionsHTML = '';
                for (let j = 0; j < test.optionsCount; j++) {
                    const letter = String.fromCharCode(65 + j);
                    optionsHTML += `
                        <div class="option-item" onclick="selectOption(this, 'student-closed-${i}')" data-value="${letter}">
                            <div class="option-letter">${letter}</div>
                            <div class="option-text">${letter} variant</div>
                        </div>
                    `;
                }
                
                div.innerHTML = `
                    <div class="question-title">Yopiq savol ${i}:</div>
                    <div class="options-grid">
                        ${optionsHTML}
                    </div>
                    <input type="hidden" id="student-closed-${i}" value="">
                `;
                form.appendChild(div);
            }
        }

        // Select option for closed questions
        function selectOption(element, questionId) {
            const container = element.parentElement;
            const value = element.getAttribute('data-value');
            
            // Remove selected class from all options
            container.querySelectorAll('.option-item').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            element.classList.add('selected');
            
            // Update hidden input value
            document.getElementById(questionId).value = value;
        }

        // Cancel test
        function cancelTest() {
            if (confirm('Testni bekor qilmoqchimisiz? Barcha javoblar yo\'qoladi.')) {
                document.getElementById('test-section').classList.add('hidden');
                document.getElementById('student-alert').style.display = 'none';
                testInProgress = false;
                currentTest = null;
            }
        }

        // Submit test
        function submitTest() {
            const testCode = document.getElementById('student-test-code').value.trim().toUpperCase();
            const studentName = document.getElementById('student-name').value.trim();

            if (!currentTest) {
                showAlert('Test ma\'lumotlari topilmadi!', 'error', 'student-alert');
                return;
            }

            const answers = {};
            let score = 0;
            let totalQuestions = currentTest.openCount + currentTest.closedCount;
            let unanswered = 0;

            // Collect and check open answers
            for (let i = 1; i <= currentTest.openCount; i++) {
                const studentAnswer = document.getElementById(`student-open-${i}`).value.trim().toLowerCase();
                const correctAnswer = currentTest.answers[`open-${i}`];
                
                answers[`open-${i}`] = studentAnswer;
                
                if (!studentAnswer) unanswered++;
                else if (correctAnswer && studentAnswer === correctAnswer) {
                    score++;
                }
            }

            // Collect and check closed answers
            for (let i = 1; i <= currentTest.closedCount; i++) {
                const studentAnswer = document.getElementById(`student-closed-${i}`).value;
                const correctAnswer = currentTest.answers[`closed-${i}`];
                
                answers[`closed-${i}`] = studentAnswer;
                
                if (!studentAnswer) unanswered++;
                else if (studentAnswer === correctAnswer) {
                    score++;
                }
            }

            if (unanswered > 0 && !confirm(`${unanswered} ta savolga javob bermadingiz. Testni yakunlamoqchimisiz?`)) {
                return;
            }

            // Save student result
            if (!testData[testCode].students) {
                testData[testCode].students = {};
            }

            const percentage = Math.round((score / totalQuestions) * 100);
            
            testData[testCode].students[studentName] = {
                answers: answers,
                score: score,
                total: totalQuestions,
                percentage: percentage,
                telegramId: telegramId,
                timestamp: new Date().toLocaleString('uz-UZ')
            };

            localStorage.setItem('testData', JSON.stringify(testData));

            // Show results
            showTestResults(score, totalQuestions, percentage);
        }

        // Show test results
        function showTestResults(score, total, percentage) {
            document.getElementById('test-section').classList.add('hidden');
            document.getElementById('test-result-section').classList.remove('hidden');
            
            document.getElementById('result-score').textContent = `${score}/${total}`;
            document.getElementById('result-percentage').textContent = `${percentage}%`;
            document.getElementById('result-progress').style.width = `${percentage}%`;
            
            let message = '';
            if (percentage >= 90) message = 'Ajoyib! Siz a\'lo bahoga erishdingiz!';
            else if (percentage >= 75) message = 'Yaxshi! Siz yaxshi natija ko\'rsatdingiz.';
            else if (percentage >= 50) message = 'Qoniqarli. Yana bir bor urinib ko\'ring.';
            else message = 'Qoniqarsiz. Qo\'shimcha mashq qilishingiz kerak.';
            
            document.getElementById('result-message').textContent = message;
            
            testInProgress = false;
        }

        // Restart test
        function restartTest() {
            document.getElementById('test-result-section').classList.add('hidden');
            document.getElementById('student-test-code').value = '';
            document.getElementById('student-name').value = '';
        }

        // Load results
        function loadResults() {
            if (!isAdmin) {
                showAlert('❌ Sizda admin huquqlari yo\'q!', 'error', 'results-alert');
                return;
            }
            
            const testCode = document.getElementById('results-test-code').value.trim().toUpperCase();
            
            if (!testCode) {
                showAlert('Test kodi kerak!', 'error', 'results-alert');
                return;
            }

            // LocalStorage dan yangi ma'lumot olish
            testData = JSON.parse(localStorage.getItem('testData') || '{}');
            
            if (!testData[testCode]) {
                showAlert('Test topilmadi!', 'error', 'results-alert');
                return;
            }

            const testInfo = testData[testCode];
            const students = testInfo.students || {};
            const resultsSection = document.getElementById('results-section');

            if (Object.keys(students).length === 0) {
                resultsSection.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Hali hech kim test topshirmagan.</div>';
                return;
            }

            let html = `<h3><i class="fas fa-list-ol"></i> ${testInfo.title} - Test natijalari:</h3>`;
            
            // Sort students by score (descending)
            const sortedStudents = Object.entries(students).sort((a, b) => b[1].score - a[1].score);
            
            sortedStudents.forEach(([name, data]) => {
                html += `
                    <div class="result-item">
                        <div class="result-header">
                            <div class="result-name">${name}</div>
                            <div class="score">${data.score}/${data.total}</div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: ${data.percentage}%"></div>
                        </div>
                        <div class="result-details">
                            <div><i class="fas fa-percentage"></i> ${data.percentage}%</div>
                            <div><i class="fas fa-id-card"></i> ${data.telegramId || 'Noma\'lum'}</div>
                            <div><i class="fas fa-clock"></i> ${data.timestamp}</div>
                        </div>
                    </div>
                `;
            });

            html += `
                <button class="btn btn-primary" onclick="exportResults('${testCode}')" style="width: 100%; margin-top: 20px;">
                    <i class="fas fa-file-excel"></i> Excel ga export qilish
                </button>
            `;
            
            resultsSection.innerHTML = html;
            showAlert(`✅ ${sortedStudents.length} ta natija yuklandi`, 'success', 'results-alert');
        }

        // Export results
        function exportResults(testCode) {
            const testInfo = testData[testCode];
            const students = testInfo.students || {};

            let csv = 'Ism Familiya,Telegram ID,To\'g\'ri javoblar,Umumiy savollar,Foiz,Vaqt\n';
            
            Object.entries(students).forEach(([name, data]) => {
                csv += `"${name}",${data.telegramId},${data.score},${data.total},${data.percentage}%,"${data.timestamp}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `test_${testCode}_results_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('Natijalar yuklab olindi!', 'success', 'results-alert');
        }

        // Show alert message
        function showAlert(message, type, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = `
                <div class="alert ${type === 'success' ? 'alert-success' : 'alert-error'}">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                    ${message}
                </div>
            `;
            container.style.display = 'block';
            
            setTimeout(() => {
                container.style.display = 'none';
            }, 5000);
        }

        // Debug function
        function debugStorage() {
            const storage = localStorage.getItem('testData');
            console.log('LocalStorage content:', storage);
            
            if (storage) {
                const parsed = JSON.parse(storage);
                console.log('Parsed testData:', parsed);
                
                let debugInfo = 'LocalStorage ma\'lumotlari:\n\n';
                Object.keys(parsed).forEach(testCode => {
                    const test = parsed[testCode];
                    debugInfo += `Test: ${testCode}\n`;
                    debugInfo += `- Nomi: ${test.title}\n`;
                    debugInfo += `- Savollar: ${test.openCount} ochiq + ${test.closedCount} yopiq = ${test.openCount + test.closedCount}\n`;
                    debugInfo += `- Javoblar: ${Object.keys(test.answers || {}).length}\n`;
                    debugInfo += `- Topshirganlar: ${Object.keys(test.students || {}).length}\n\n`;
                });
                
                alert(debugInfo);
            } else {
                alert('LocalStorage bo\'sh!');
            }
        }
    </script>
</body>
</html>
